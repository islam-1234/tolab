<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>طلاب م/ حنان عبدالغني - مادة اللغة الإنجليزية</title>
    <style>
        * {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #333;
        }
        
        .container {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        h1 {
            color: #2575fc;
            font-size: 22px;
            margin-bottom: 5px;
        }
        
        h2 {
            color: #6a11cb;
            font-size: 18px;
            margin-top: 0;
            margin-bottom: 25px;
        }
        
        .input-group {
            margin-bottom: 20px;
            text-align: right;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #444;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            transition: all 0.3s;
        }
        
        input[type="text"]:focus {
            border-color: #6a11cb;
            box-shadow: 0 0 8px rgba(106, 17, 203, 0.3);
            outline: none;
        }
        
        .grade-selection {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 25px;
        }
        
        .grade-btn {
            padding: 12px;
            background-color: #f5f5f5;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .grade-btn:hover {
            background-color: #e9e9e9;
        }
        
        .grade-btn.selected {
            background-color: #6a11cb;
            color: white;
            border-color: #6a11cb;
        }
        
        .submit-btn {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            width: 100%;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            margin-bottom: 15px;
        }
        
        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .submit-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        .submit-btn:active {
            transform: translateY(0);
        }
        
        .toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #4CAF50;
            color: white;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 1;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .toast.error {
            background-color: #ff4d4d;
        }
        
        .toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        
        @keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 30px; opacity: 1;}
        }
        
        @keyframes fadeout {
            from {bottom: 30px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }
        
        .error-message {
            color: #ff4d4d;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }
        
        .already-registered {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
            display: none;
        }
        
        .registered-info {
            font-weight: bold;
            color: #6a11cb;
        }
        
        .loading {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6a11cb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .dashboard-link {
            display: block;
            margin-top: 20px;
            color: #2575fc;
            text-decoration: none;
            font-weight: bold;
        }
        
        .dashboard-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="loading" id="loading">
            <div class="spinner"></div>
        </div>
        
        <h1>طلاب م/ حنان عبدالغني</h1>
        <h2>مادة اللغة الإنجليزية</h2>
        
        <div class="already-registered" id="alreadyRegistered">
            <p>لقد قمت بالتسجيل مسبقاً</p>
            <p>اسم الطالب: <span class="registered-info" id="registeredName"></span></p>
            <p>رقم الهاتف: <span class="registered-info" id="registeredPhone"></span></p>
            <p>المرحلة: <span class="registered-info" id="registeredGrade"></span></p>
            <p>سيتم إغلاق هذه الصفحة تلقائياً خلال <span id="countdown">10</span> ثوانٍ</p>
        </div>
        
        <form id="studentForm">
            <div class="input-group">
                <label for="studentName">اسم الطالب</label>
                <input type="text" id="studentName" required>
                <div class="error-message" id="nameError">هذا الاسم مسجل بالفعل</div>
            </div>
            
            <div class="input-group">
                <label for="phoneNumber">رقم الهاتف / رقم ولي الأمر</label>
                <input type="text" id="phoneNumber" required>
                <div class="error-message" id="phoneError">هذا الرقم مسجل بالفعل</div>
            </div>
            
            <div class="input-group">
                <label>المرحلة الدراسية</label>
                <div class="grade-selection">
                    <div class="grade-btn" data-grade="الرابع الابتدائي">الرابع الابتدائي</div>
                    <div class="grade-btn" data-grade="الخامس الابتدائي">الخامس الابتدائي</div>
                    <div class="grade-btn" data-grade="السادس الابتدائي">السادس الابتدائي</div>
                    <div class="grade-btn" data-grade="الأول الإعدادي">الأول الإعدادي</div>
                    <div class="grade-btn" data-grade="الثاني الإعدادي">الثاني الإعدادي</div>
                    <div class="grade-btn" data-grade="الثالث الإعدادي">الثالث الإعدادي</div>
                </div>
            </div>
            
            <button type="submit" class="submit-btn" id="submitBtn">تسجيل البيانات</button>
        </form>
        
        <a href="dashboard.html" class="dashboard-link">الدخول إلى لوحة التحكم (للمعلم فقط)</a>
    </div>
    
    <div id="toast" class="toast"></div>

    <!-- Firebase App (core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB27lyphN9YxgB4eFwuKWi0ghjuAutpu8o",
            authDomain: "manssa-oloom1352007.firebaseapp.com",
            projectId: "manssa-oloom1352007",
            storageBucket: "manssa-oloom1352007.firebasestorage.app",
            messagingSenderId: "191595591961",
            appId: "1:191595591961:web:79ff9bbb52cc08cb862d88",
            measurementId: "G-B57GFGNW3B"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // DOM elements
        const form = document.getElementById('studentForm');
        const gradeButtons = document.querySelectorAll('.grade-btn');
        const toast = document.getElementById('toast');
        const nameError = document.getElementById('nameError');
        const phoneError = document.getElementById('phoneError');
        const studentNameInput = document.getElementById('studentName');
        const phoneNumberInput = document.getElementById('phoneNumber');
        const submitBtn = document.getElementById('submitBtn');
        const alreadyRegistered = document.getElementById('alreadyRegistered');
        const registeredName = document.getElementById('registeredName');
        const registeredPhone = document.getElementById('registeredPhone');
        const registeredGrade = document.getElementById('registeredGrade');
        const loading = document.getElementById('loading');
        const countdownElement = document.getElementById('countdown');
        
        let selectedGrade = '';
        let existingStudents = [];
        let countdownInterval;
        
        // Check if student is already registered
        function checkIfRegistered() {
            const registeredStudent = localStorage.getItem('registeredStudent_hannan');
            if (registeredStudent) {
                const student = JSON.parse(registeredStudent);
                alreadyRegistered.style.display = 'block';
                form.style.display = 'none';
                registeredName.textContent = student.name;
                registeredPhone.textContent = student.phone;
                registeredGrade.textContent = student.grade;
                
                // بدء العد التنازلي لإغلاق الصفحة
                let countdown = 10;
                countdownInterval = setInterval(() => {
                    countdown--;
                    countdownElement.textContent = countdown;
                    
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        window.close(); // إغلاق النافذة
                    }
                }, 1000);
            }
        }
        
        // Load existing students to check for duplicates
        async function loadExistingStudents() {
            try {
                loading.style.display = 'flex';
                const snapshot = await db.collection('students').get();
                existingStudents = [];
                
                snapshot.forEach(doc => {
                    const studentData = doc.data();
                    existingStudents.push({
                        name: studentData.name,
                        phone: studentData.phone
                    });
                });
                
                loading.style.display = 'none';
            } catch (error) {
                console.error('Error loading students: ', error);
                loading.style.display = 'none';
                showToast('حدث خطأ في تحميل البيانات', true);
            }
        }
        
        // Check if student name already exists
        function isNameExists(name) {
            return existingStudents.some(student => 
                student.name.trim().toLowerCase() === name.trim().toLowerCase()
            );
        }
        
        // Check if phone number already exists
        function isPhoneExists(phone) {
            return existingStudents.some(student => student.phone === phone);
        }
        
        // Validate form inputs
        function validateForm() {
            const name = studentNameInput.value.trim();
            const phone = phoneNumberInput.value.trim();
            let isValid = true;
            
            // Reset error messages
            nameError.style.display = 'none';
            phoneError.style.display = 'none';
            
            // Check if name exists
            if (name && isNameExists(name)) {
                nameError.style.display = 'block';
                isValid = false;
            }
            
            // Check if phone exists
            if (phone && isPhoneExists(phone)) {
                phoneError.style.display = 'block';
                isValid = false;
            }
            
            // Check if grade is selected
            if (!selectedGrade) {
                isValid = false;
            }
            
            // Enable/disable submit button
            submitBtn.disabled = !isValid;
            
            return isValid;
        }
        
        // Grade selection
        gradeButtons.forEach(button => {
            button.addEventListener('click', () => {
                gradeButtons.forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
                selectedGrade = button.getAttribute('data-grade');
                validateForm();
            });
        });
        
        // Input validation on typing
        studentNameInput.addEventListener('input', validateForm);
        phoneNumberInput.addEventListener('input', validateForm);
        
        // Form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!validateForm()) {
                showToast('يرجى تصحيح الأخطاء في النموذج', true);
                return;
            }
            
            const studentName = studentNameInput.value;
            const phoneNumber = phoneNumberInput.value;
            
            try {
                loading.style.display = 'flex';
                
                // Add student data to Firestore
                await db.collection('students').add({
                    name: studentName,
                    phone: phoneNumber,
                    grade: selectedGrade,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Save to local storage to prevent re-registration
                localStorage.setItem('registeredStudent_hannan', JSON.stringify({
                    name: studentName,
                    phone: phoneNumber,
                    grade: selectedGrade
                }));
                
                // Add to existing students to prevent duplicate in same session
                existingStudents.push({
                    name: studentName,
                    phone: phoneNumber
                });
                
                // Show success message
                showToast('تم حفظ البيانات بنجاح! شكراً لك.');
                
                // Hide form and show registered info
                alreadyRegistered.style.display = 'block';
                form.style.display = 'none';
                registeredName.textContent = studentName;
                registeredPhone.textContent = phoneNumber;
                registeredGrade.textContent = selectedGrade;
                
                // بدء العد التنازلي لإغلاق الصفحة
                let countdown = 10;
                countdownInterval = setInterval(() => {
                    countdown--;
                    countdownElement.textContent = countdown;
                    
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        window.close(); // إغلاق النافذة
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error adding document: ', error);
                showToast('حدث خطأ أثناء حفظ البيانات. يرجى المحاولة مرة أخرى.', true);
            } finally {
                loading.style.display = 'none';
            }
        });
        
        // Show toast notification
        function showToast(message, isError = false) {
            toast.textContent = message;
            if (isError) {
                toast.className = 'toast error show';
            } else {
                toast.className = 'toast show';
            }
            
            setTimeout(() => {
                toast.className = toast.className.replace('show', '');
            }, 3000);
        }
        
        // Initial load
        checkIfRegistered();
        loadExistingStudents();
    </script>
</body>
</html>
